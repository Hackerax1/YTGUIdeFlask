<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' https://www.youtube.com; img-src 'self' https: data:; frame-src https://www.youtube.com;">
    <meta http-equiv="X-Frame-Options" content="DENY">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <title>YouTube TV Guide</title>
    <link rel="stylesheet" href="/static/css/theme1.css" id="themeStylesheet">
    <link rel="stylesheet" href="/static/css/modal.css">
    <style>
        .page-loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            flex-direction: column;
            color: white;
        }
        
        .spinner {
            border: 5px solid rgba(255, 255, 255, 0.3);
            border-top: 5px solid #ffffff;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Page Loading Indicator -->
    <div class="page-loader" id="pageLoader">
        <div class="spinner"></div>
        <p>Loading TV guide data...</p>
    </div>

    <div class="container">
        <h1>YouTube TV Guide</h1>
        <div class="theme-switcher">
            <button onclick="switchTheme('/static/css/theme1.css')">Classic Guide</button>
            <button onclick="switchTheme('/static/css/theme2.css')">Night Mode</button>
            <button onclick="switchTheme('/static/css/theme3.css')">Retro Guide</button>
        </div>
        
        <div class="time-bar">
            <div class="current-time">{{ current_time }}</div>
            <div class="timeline">
                <div class="play-head" id="playHead"></div>
                <div class="time-markers">
                    <!-- Time markers will be generated dynamically by JavaScript -->
                </div>
            </div>
        </div>
        
        <div class="guide-container">
            <div class="channel-numbers">
                {% for channel in channels %}
                <div class="channel-number">{{ channel.stationId }}</div>
                {% endfor %}
            </div>
            
            <div class="guide-content">
                {% for channel in channels %}
                <div class="guide-row">
                    <div class="channel-info">
                        <div class="channel-name">{{ channel.name }}</div>
                        <div class="display-option">{{ channel.displayOption|title }}</div>
                    </div>
                    <div class="program-grid" role="grid">
                        {% if channel.videos %}
                            {% set row_loop = loop %}
                            {% for video in channel.videos[:3] %}
                            <div class="program{% if video.is_current %} current{% endif %}{% if not video.is_current %} unavailable{% endif %}" 
                                role="gridcell"
                                tabindex="{% if video.is_current %}-1{% else %}0{% endif %}"
                                data-row="{{ row_loop.index0 }}"
                                data-col="{{ loop.index0 }}"
                                data-video-id="{{ video.id }}"
                                data-video-title="{{ video.title }}"
                                data-description="{{ video.description if video.description else 'No description available.' }}"
                                data-duration="{{ video.duration }}"
                                aria-label="{{ 'Currently playing: ' if video.is_current }}{{ video.title }}">
                                <div class="program-info">
                                    <div class="program-title">{{ video.title }}</div>
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <div class="program no-content" role="status">
                                <p>No videos available</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        
        <div class="guide-footer">
            <div class="footer-buttons">
                <button onclick="location.href='/manage'" tabindex="-1">Manage Channels</button>
            </div>
            <div class="footer-info">
                Use arrow keys to navigate • Enter to play current programs • Esc to close video
            </div>
        </div>
    </div>
    
    <!-- Video Player Modal -->
    <div id="videoModal" class="modal" role="dialog" aria-labelledby="videoTitle" aria-modal="true">
        <div class="modal-content">
            <span class="close-modal" onclick="closeVideoModal()" aria-label="Close video" tabindex="0">&times;</span>
            <div class="video-container">
                <div class="video-loading" id="videoLoading">
                    <div class="loading-spinner"></div>
                    <p>Loading video...</p>
                </div>
                <iframe id="videoPlayer" frameborder="0" allowfullscreen title="YouTube video player"></iframe>
            </div>
            <div class="video-info">
                <div id="videoTitle" class="video-title"></div>
                <div id="videoDescription" class="video-description"></div>
            </div>
            <div class="video-controls">
                <button class="control-btn" onclick="openInYouTube()" aria-label="Open in YouTube">Open in YouTube</button>
                <button class="control-btn" onclick="closeVideoModal()" aria-label="Close video player">Close</button>
            </div>
        </div>
    </div>

    <!-- Update script tag to use ES modules -->
    <script type="module" src="/static/js/index.js"></script>
</body>
</html>